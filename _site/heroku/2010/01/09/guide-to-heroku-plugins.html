<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
	<head>
		<title>wornpath - Guide to Heroku Plugins</title>
		<link rel="stylesheet" type="text/css" href="/css/style.css" media="screen" />
		<link rel="stylesheet" type="text/css" href="/css/syntax.css" media="screen" />
		<meta name="author" content="Terence Lee" />
	</head>
	<body>
		<div id="header">
			<h1>wornpath</h1>
			<h2>The journey of a software craftsman</h2>
			<div id="menu">
				<ul id="nav">
					<li><a href="/">blog</a></li>
					<li><a href="/about.html">about</a></li>
				</ul>
			</div>
		</div>
		<div id="content">
			<div id="right">
				<h2>Guide to Heroku Plugins</h2>
<div id="date">published 09 Jan 2010</div>
<div id="categories">categories: 
	
	<a href="/heroku.html">heroku</a> 
	
</div>
<p>
<p>As of <a href="http://github.com/heroku/heroku/commits/v1.5">heroku gem 1.5</a>, heroku introduced a plugin system to their gem.  The significance of this is that now you can push your own features to the gem without waiting for the heroku team to approve it and provide a way for others to get those changes.  I had three features that didn&#8217;t make it into the heroku gem which are now pluginified and can be found here:</p>
<ul>
	<li><a href="http://github.com/hone/heroku_switch_command">switch command</a> &#8211; switches the default heroku remote, for managing multiple apps</li>
	<li><a href="http://github.com/hone/heroku_tab_complete_console">tab complete console</a> &#8211; partial tab complete support for heroku console</li>
	<li><a href="http://github.com/hone/heroku_colorize_console">colorize console</a> &#8211; color support with wirble on heroku console</li>
</ul>
<h3>Usage</h3>
<p>Installing a gem is quite simple.  You just need to get the git url of the gem and run the install command.  For example to install the colorize console plugin above, just do</p>
<p><code>heroku plugins:install git://github.com/hone/heroku_colorize_console.git</code></p>
<p>This will clone the git repo into your ~/.heroku/plugins directory and gets automatically loaded when running the heroku client now.  There currently is no way to disable certain gems that are already installed.  Also errors while loading/running the plugin are not cleanly handled by the heroku gem yet.</p>
<h3>Rolling your own</h3>
<p>Pedro based the heroku plugin system off of rails plugins.  The file structure is similar:</p>
<div class="highlight"><pre><code class="ruby"><span class="o">|--</span> <span class="n">lib</span><span class="o">/</span>
    <span class="o">|--</span> <span class="n">plugin</span> <span class="n">files</span><span class="o">.</span><span class="n">.</span><span class="o">.</span>
<span class="o">|--</span> <span class="no">README</span>
<span class="o">|--</span> <span class="n">init</span><span class="o">.</span><span class="n">rb</span>
</code></pre>
</div><p>The <code>init.rb</code> is the file that gets loaded when the heroku gem gets run.  This file loads the rest of the plugin.  For example in my colorize console plugin, my init.rb looks like this:</p>
<div class="highlight"><pre><code class="ruby"><span class="nb">require</span> <span class="s1">&#39;wirble&#39;</span>
<span class="nb">require</span> <span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">__FILE__</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/lib/heroku_colorize_console&#39;</span>
</code></pre>
</div><p>When ovewriting an existing heroku gem method, tread carefully.  Try not to copy and paste the existing method into your plugin and then edit it there.  If possible use the alias_method_chain pattern from rails.  This is how I handle ovewriting <code>Heroku::Command::Base#display</code></p>
<div class="highlight"><pre><code class="ruby"><span class="k">def</span> <span class="nf">display_with_colorize</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="kp">true</span><span class="p">)</span>
  <span class="n">msg</span> <span class="o">=</span> <span class="no">Wirble</span><span class="o">::</span><span class="no">Colorize</span><span class="o">.</span><span class="n">colorize</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="k">if</span> <span class="vi">@options</span> <span class="ow">and</span> <span class="vi">@options</span><span class="o">[</span><span class="ss">:colorize</span><span class="o">]</span>
  <span class="n">display_without_colorize</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">newline</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">alias_method</span> <span class="ss">:display_without_colorize</span><span class="p">,</span> <span class="ss">:display</span>
<span class="n">alias_method</span> <span class="ss">:display</span><span class="p">,</span> <span class="ss">:display_with_colorize</span>
</code></pre>
</div><h4>New Commandments!</h4>
<p>When adding new commands into the heroku gem, if you&#8217;re going to add whole set of features like <code>bundles</code> or <code>addons</code> then create your own class to do it.  If you&#8217;re only adding one simple command like the switch plugin, then just add it to <code>Heroku::Command::Base</code>.  Finally, don&#8217;t forget to add an entry into the help system, so people know how to use your new fangled command.  This is what my switch command looks like:</p>
<div class="highlight"><pre><code class="ruby"><span class="k">module</span> <span class="nn">Heroku::Command</span>
  <span class="k">class</span> <span class="nc">Base</span>
    <span class="no">DEFAULT_HEROKU_REMOTE_NAME</span> <span class="o">=</span> <span class="s2">&quot;heroku&quot;</span>
 
    <span class="c1"># switches which heroku app to use (sets it as the default)</span>
    <span class="k">def</span> <span class="nf">switch</span>
      <span class="k">unless</span> <span class="vi">@args</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">raise</span><span class="p">(</span><span class="no">CommandFailed</span><span class="p">,</span> <span class="s2">&quot;Need to specify heroku app to switch to&quot;</span><span class="p">)</span>
      <span class="k">end</span>
 
      <span class="n">git_repo</span> <span class="o">=</span> <span class="o">::</span><span class="no">Git</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="no">Dir</span><span class="o">.</span><span class="n">pwd</span><span class="p">)</span>
      <span class="n">git_repo</span><span class="o">.</span><span class="n">remotes</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">remote</span><span class="o">|</span>
        <span class="k">if</span> <span class="n">remote</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span> <span class="o">==</span> <span class="n">default_git_remote_host</span>
          <span class="k">begin</span>
            <span class="n">remote</span><span class="o">.</span><span class="n">remove</span>
            <span class="c1"># remove command isn&#39;t working for ruby-git 1.2.5</span>
          <span class="k">rescue</span> <span class="no">Git</span><span class="o">::</span><span class="no">GitExecuteError</span>
            <span class="n">shell</span><span class="p">(</span><span class="s2">&quot;git remote rm </span><span class="si">#{</span><span class="n">remote</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">end</span>
        <span class="k">end</span>
      <span class="k">end</span>
 
      <span class="n">remote_location</span> <span class="o">=</span> <span class="n">default_git_remote_path</span><span class="p">(</span><span class="vi">@args</span><span class="o">.</span><span class="n">first</span><span class="p">)</span>
      <span class="n">git_repo</span><span class="o">.</span><span class="n">add_remote</span><span class="p">(</span><span class="no">DEFAULT_HEROKU_REMOTE_NAME</span><span class="p">,</span> <span class="n">remote_location</span><span class="p">)</span>
    <span class="k">end</span>
 
    <span class="k">def</span> <span class="nf">default_git_remote_path</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
      <span class="s2">&quot;</span><span class="si">#{</span><span class="n">default_git_remote_host</span><span class="si">}</span><span class="s2">:</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">.git&quot;</span>
    <span class="k">end</span>
 
    <span class="k">def</span> <span class="nf">default_git_remote_host</span>
      <span class="s2">&quot;git@</span><span class="si">#{</span><span class="n">heroku</span><span class="o">.</span><span class="n">host</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">end</span>
  <span class="k">end</span>
 
  <span class="k">class</span> <span class="nc">Help</span>
    <span class="k">def</span> <span class="nf">usage_with_switch_command</span>
      <span class="n">message</span> <span class="o">=</span> <span class="n">usage_without_switch_command</span>
      <span class="n">message</span> <span class="o">+=</span> <span class="o">&lt;&lt;</span><span class="no">TEXT</span>
<span class="sh"> </span>
<span class="sh">=== Switch Command</span>
<span class="sh"> </span>
<span class="sh">switch &lt;appname&gt; # set as the default heroku remote, to run commands against by default</span>
<span class="sh"> </span>
<span class="sh"> </span>
<span class="no">TEXT</span>
 
      <span class="n">message</span>
    <span class="k">end</span>
 
    <span class="n">alias_method</span> <span class="ss">:usage_without_switch_command</span><span class="p">,</span> <span class="ss">:usage</span>
    <span class="n">alias_method</span> <span class="ss">:usage</span><span class="p">,</span> <span class="ss">:usage_with_switch_command</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div><h3>Caveats</h3>
<p>I know ddollar has added in a new pluggable help system.  I&#8217;ll update my switch command to reflect this change and the blog post as well.  Versioning and depndency issues are still yet to be sorted/handled by the heroku gem.  I think using something like git tags in conjunction with <a href="http://github.com/dazuma/versionomy/">versionomy</a> or switching over to rubygems would be a good solution to those issues.  Lastly, I need to bring over my tests into these plugins and layout a good way to test heroku plugins.</p>
</p>
<hr />
<div id="disqus_thread"></div><script type="text/javascript" src="http://disqus.com/forums/wornpath/embed.js"></script><noscript><a href="http://disqus.com/forums/wornpath/?url=ref">View the discussion thread.</a></noscript><a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

			</div>

			<div id="left">
				<div class="box">
					<h2>categories:</h2>	
					<ul>
						<li><a href="/heroku.html">heroku</a> (1)</li>
					</ul>
				</div>

				<div class="box">
					<h2>interwebs:</h2>	
					<ul>
						<li><a href="http://www.github.com/hone/">github</a></li>
						<li><a href="http://www.linkedin.com/in/hone02">linkedin</a></li>
						<li><a href="http://www.workingwithrails.com/person/8768-terence-lee">working with rails</a></li>
						<li><a href="http://www.twitter.com/hone02">twitter</a></li>
						<li><a href="http://www.facebook.com/#/profile.php?ref=profile&id=5401111">facebook</a></li>
						<li><a href="http://profiles.us.playstation.com/playstation/psn/profiles/hone02">playstation network</a></li>
						<li><a href="http://steamcommunity.com/profiles/76561197992155274">steam</a></li>
					</ul>
				</div>

				<div class="box">
					<h2>links :</h2>
					<ul>
						<li><a href="/atom.xml">feed</a></li>
						<li><a href="http://www.github.com/hone/wornpath">code</a> @ <a href="http://www.github.com">github</a></li>
						<li><a href="http://github.com/bry4n/rack-jekyll">rack-jekyll</a> powered</li>
						<li>licensed with <a href="http://creativecommons.org/licenses/by-sa/3.0/us/">creative commons</a></li>
						<li>hosted by <a href="http://www.heroku.com">heroku</a></li>
					</ul>
				</div>

				<div class="box">
					<div style="font-size: 0.8em;">Design by <a href="http://www.minimalistic-design.net">Minimalistic Design</a></div>
				</div>
			</div>
		</div>
		<script type="text/javascript">
//<![CDATA[
(function() {
	var links = document.getElementsByTagName('a');
	var query = '?';
	for(var i = 0; i < links.length; i++) {
	if(links[i].href.indexOf('#disqus_thread') >= 0) {
		query += 'url' + i + '=' + encodeURIComponent(links[i].href) + '&';
	}
	}
	document.write('<script charset="utf-8" type="text/javascript" src="http://disqus.com/forums/wornpath/get_num_replies.js' + query + '"></' + 'script>');
})();
//]]>
		</script>
	</body>
</html>
