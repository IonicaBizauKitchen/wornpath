<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
	<head>
		<title>wornpath - hone.heroku.com</title>
		<link rel="stylesheet" type="text/css" href="/css/style.css" media="screen" />
		<link rel="stylesheet" type="text/css" href="/css/syntax.css" media="screen" />
		<meta name="author" content="Terence Lee" />
	</head>
	<body>
		<div id="header">
			<h1>wornpath</h1>
			<h2>The journey of a software craftsman</h2>
			<div id="menu">
				<ul id="nav">
					<li><a href="/">blog</a></li>
					<li><a href="/about.html">about</a></li>
				</ul>
			</div>
		</div>
		<div id="content">
			<div id="right">
				
<h2><a href="/rails/2010/02/02/rails-23-and-bundler.html">Rails 2.3 and Bundler</a></h2>
<div id="date">published 02 Feb 2010</div>
<div id="categories">categories: 
	
	<a href="/rails.html">rails</a> 
	
</div>
<p>Here at <a href="http://www.otherinbox.com">OtherInbox</a>, we&#8217;ve had some issues dealing with gem dependencies using <code>config.gem</code>.  Luckily, <a href="http://twitter.com/carllerche">Carl Lerche</a> and <a href="http://yehudakatz.com/">Yehuda Katz</a> have made <a href="http://github.com/wycats/bundler/">Bundler</a> for us.  Bundler has great dependency resolution and just works&#8482;.  <a href="http://yehudakatz.com/2010/02/01/bundler-0-9-heading-toward-1-0/">They&#8217;re also smoothing out deployment workflow issues.</a></p>
<h3>Getting Setup with Rails 2.3.x</h3>
<p>Setting up Bundler on Rails 2.3.x is fairly straightforward.  There&#8217;s only 3 steps.</p>
<p>1. setup the Gemfile<br />
2. setup the preinitializer.rb<br />
3. monkey patch the boot.rb</p>
<h4>Setup the Gemfile</h4>
<p>The Gemfile is the manifest file that lists what gems are part of the application and what environment they belong in.  Bundler defaults the gems in <code>vendor/gems/</code> and the binaries in <code>bin/</code>.  Unfortunately, <code>vendor/gems/</code> is special to rails, so you need to specify a different directoy to use: <code>bundle_path "vendor/bundler_gems"</code>.  Specifying a gem is as easy as this:</p>
<div class="highlight"><pre><code class="ruby"><span class="n">gem</span> <span class="s2">&quot;&lt;gem name&gt;&quot;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">options</span><span class="o">&gt;</span>
</code></pre>
</div><p>The options are well, optional.  You can specify the version number.  You can also specify what to require if the lib doesn&#8217;t match gem name.  You will need to do this for gems from <a href="http://www.github.com">github</a>, since they&#8217;re prefixed with github usernames.  There&#8217;s also a <code>:only</code>  and <code>:except</code> options for specifying which environments the gem should be in. See the following example:</p>
<div class="highlight"><pre><code class="ruby"><span class="n">gem</span> <span class="s1">&#39;mislav-will_paginate&#39;</span><span class="p">,</span> <span class="s1">&#39;2.3.8&#39;</span><span class="p">,</span> <span class="ss">:require_as</span> <span class="o">=&gt;</span> <span class="s1">&#39;will_paginate&#39;</span><span class="p">,</span> <span class="ss">:except</span> <span class="o">=&gt;</span> <span class="ss">:test</span>
</code></pre>
</div><p>You can use <code>source</code> to specify different gem sources outside of <a href="http://rubyforge.org/">rubyforge</a> and <a href="http://gemcutter.org">gemcutter</a> .  For instance, I have</p>
<div class="highlight"><pre><code class="ruby"><span class="n">source</span> <span class="s2">&quot;http://gems.github.com&quot;</span>
</code></pre>
</div><p>in my Gemfile to use github.</p>
<p>You use <code>only</code> and <code>except</code> blocks to specify multiple gems for a particular staging environment.</p>
<p>Here&#8217;s my <a href="http://github.com/hone/herocutter/blob/master/Gemfile">example Gemfile</a> for <a href="http://herocutter.heroku.com">herocutter</a>:</p>
<div class="highlight"><pre><code class="ruby"><span class="n">bundle_path</span> <span class="s2">&quot;vendor/bundler_gems&quot;</span>

<span class="n">gem</span> <span class="s1">&#39;rails&#39;</span><span class="p">,</span>      <span class="s1">&#39;2.3.5&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;postgres&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;clearance&#39;</span><span class="p">,</span>  <span class="s1">&#39;0.8.4&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;gravtastic&#39;</span><span class="p">,</span> <span class="s1">&#39;2.2.0&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;formtastic&#39;</span><span class="p">,</span> <span class="s1">&#39;0.9.7&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;git&#39;</span><span class="p">,</span>        <span class="s1">&#39;1.2.5&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;pacecar&#39;</span><span class="p">,</span>    <span class="s1">&#39;1.2.0&#39;</span>

<span class="n">only</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;factory_girl&#39;</span><span class="p">,</span>     <span class="s1">&#39;1.2.3&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;cucumber&#39;</span><span class="p">,</span>         <span class="s1">&#39;0.6.1&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;cucumber-rails&#39;</span><span class="p">,</span>   <span class="s1">&#39;0.2.3&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;webrat&#39;</span><span class="p">,</span>           <span class="s1">&#39;0.6.0&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;database_cleaner&#39;</span><span class="p">,</span> <span class="s1">&#39;0.4.2&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;shoulda&#39;</span><span class="p">,</span>          <span class="s1">&#39;2.10.2&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;rr&#39;</span><span class="p">,</span>		          <span class="s1">&#39;0.10.5&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;redgreen&#39;</span>
<span class="k">end</span>

<span class="n">only</span> <span class="ss">:development</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;factory_girl&#39;</span><span class="p">,</span>     <span class="s1">&#39;1.2.3&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;n&#39;</span><span class="p">,</span>                <span class="s1">&#39;0.1.0&#39;</span>
<span class="k">end</span>
</code></pre>
</div><p>Don&#8217;t forget to remove the gems from the <code>vendor/gems/</code> directory and the <code>config.gem</code> lines from your environment files.</p>
<h5>Caveat</h5>
<p>If you use <code>disable_system_gems</code> to not search your system gems, it will not work on <a href="http://www.heroku.com">heroku</a> since their system is dependent on a system install version of thin.</p>
<p>In a consulting project when I&#8217;ve made the switch to bundler, all monkey patched gems I&#8217;ve kept those inside <code>vendor/gems/</code> as well as the appropriate <code>config.gem</code> lines in the environment files.  If you need to require their dependencies in bundler, rails won&#8217;t load the depencies properly when accessed in the <code>lib/</code> directory.  For instance, in a monkey patch to lockdown I used <a href="http://rubyforge.org/projects/parsetree/">ParseTree</a> and had to require that explicitly in <code>lib/lockdown/init.rb</code>.</p>
<h4>Setup the preinitializer.rb</h4>
<p>This step is simple.  In your <code>config/preinitializer.rb</code>, you need to get rails to load bundler in the path by adding:</p>
<div class="highlight"><pre><code class="ruby"><span class="nb">require</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">__FILE__</span><span class="p">)</span><span class="si">}</span><span class="s2">/../vendor/bundler_gems/environment&quot;</span>
</code></pre>
</div><h5>Caveat</h5>
<p>In <a href="http://yehudakatz.com/2009/11/03/using-the-new-gem-bundler-today/">Yehuda&#8217;s blog post</a>, insert the environment loading code into the <code>config/preinitializer.rb</code>.  I couldn&#8217;t get it to work quite right.</p>
<h4>Monkey Patch the boot.rb</h4>
<p>Instead of putting loading of the environment gems in <code>config/preinitializer.rb</code>, I found it works better to monkey patch <code>config/boot.rb</code> directly (got this from the <a href="http://www.github.com/qrush/gemcutter">gemcutter source</a>).  We basically need to tell rails to load the right environment gems.  You can do this by adding this to the bottom of <code>config/boot.rb</code> right before the <code>Rails.boot!</code>:</p>
<div class="highlight"><pre><code class="ruby"><span class="k">class</span> <span class="nc">Rails</span><span class="o">::</span><span class="no">Boot</span>
  <span class="k">def</span> <span class="nf">run</span>
    <span class="n">load_initializer</span>
    <span class="n">extend_environment</span>
    <span class="no">Rails</span><span class="o">::</span><span class="no">Initializer</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="ss">:set_load_path</span><span class="p">)</span>
  <span class="k">end</span>
 
  <span class="k">def</span> <span class="nf">extend_environment</span>
    <span class="no">Rails</span><span class="o">::</span><span class="no">Initializer</span><span class="o">.</span><span class="n">class_eval</span> <span class="k">do</span>
      <span class="n">old_load</span> <span class="o">=</span> <span class="nb">instance_method</span><span class="p">(</span><span class="ss">:load_environment</span><span class="p">)</span>
      <span class="n">define_method</span><span class="p">(</span><span class="ss">:load_environment</span><span class="p">)</span> <span class="k">do</span>
        <span class="no">Bundler</span><span class="o">.</span><span class="n">require_env</span> <span class="no">RAILS_ENV</span>
        <span class="n">old_load</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span><span class="o">.</span><span class="n">call</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div><p>You can also refer to the <code>config/boot.rb</code> <a href="http://github.com/hone/herocutter/commit/250fcbef213c099d06eb7dc31cc117eba7789c64#diff-1">on herocutter</a> to see what I changed exactly.</p>
<a id="more" href="/rails/2010/02/02/rails-23-and-bundler.html#disqus_thread">Comments &raquo;</a>

<hr />

<h2>archive</h2>
<ul id="archive">
	
	<li><a href="/rails/2010/02/02/rails-23-and-bundler.html">Rails 2.3 and Bundler</a> - <abbr>02 Feb 2010</abbr></li>
	
	<li><a href="/heroku/2010/01/09/guide-to-heroku-plugins.html">Guide to Heroku Plugins</a> - <abbr>09 Jan 2010</abbr></li>
	
</ul>

			</div>

			<div id="left">
				<div class="box">
					<h2>categories:</h2>	
					<ul>
						<li><a href="/heroku.html">heroku</a> (1)</li>
						<li><a href="/rails.html">rails</a> (1)</li>
					</ul>
				</div>

				<div class="box">
					<h2>interwebs:</h2>	
					<ul>
						<li><a href="http://www.github.com/hone/">github</a></li>
						<li><a href="http://www.linkedin.com/in/hone02">linkedin</a></li>
						<li><a href="http://www.workingwithrails.com/person/8768-terence-lee">working with rails</a></li>
						<li><a href="http://www.twitter.com/hone02">twitter</a></li>
						<li><a href="http://www.facebook.com/#/profile.php?ref=profile&id=5401111">facebook</a></li>
						<li><a href="http://profiles.us.playstation.com/playstation/psn/profiles/hone02">playstation network</a></li>
						<li><a href="http://steamcommunity.com/profiles/76561197992155274">steam</a></li>
					</ul>
				</div>

				<div class="box">
					<h2>links :</h2>
					<ul>
						<li><a href="/atom.xml">feed</a></li>
						<li><a href="http://www.github.com/hone/wornpath">code</a> @ <a href="http://www.github.com">github</a></li>
						<li><a href="http://github.com/bry4n/rack-jekyll">rack-jekyll</a> powered</li>
						<li>licensed with <a href="http://creativecommons.org/licenses/by-sa/3.0/us/">creative commons</a></li>
						<li>hosted by <a href="http://www.heroku.com">heroku</a></li>
					</ul>
				</div>

				<div class="box">
					<div style="font-size: 0.8em;">Design by <a href="http://www.minimalistic-design.net">Minimalistic Design</a></div>
				</div>
			</div>
		</div>
		<script type="text/javascript">
//<![CDATA[
(function() {
	var links = document.getElementsByTagName('a');
	var query = '?';
	for(var i = 0; i < links.length; i++) {
	if(links[i].href.indexOf('#disqus_thread') >= 0) {
		query += 'url' + i + '=' + encodeURIComponent(links[i].href) + '&';
	}
	}
	document.write('<script charset="utf-8" type="text/javascript" src="http://disqus.com/forums/wornpath/get_num_replies.js' + query + '"></' + 'script>');
})();
//]]>
		</script>
		<script type="text/javascript">
			var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
			document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
		</script>
		<script type="text/javascript">
			try {
				var pageTracker = _gat._getTracker("UA-12387207-1");
				pageTracker._trackPageview();
				} catch(err) {}
		</script>
	</body>
</html>
